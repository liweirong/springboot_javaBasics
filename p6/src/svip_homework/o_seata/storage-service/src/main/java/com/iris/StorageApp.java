package com.iris;

import com.iris.service.BusinessService;
import io.seata.spring.annotation.GlobalTransactional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
@EnableDiscoveryClient
public class StorageApp {

    public static void main(String[] args) {
        SpringApplication.run(StorageApp.class, args);
    }

    @Autowired
    private BusinessService service;

    @GetMapping("/seata/purchase/{param}")
    @GlobalTransactional(rollbackFor = Exception.class)
    public void seata(@PathVariable("param") String param) {
        service.purchase("11", param, 1);
    }
}

/**
 * 临时记录
 * INSERT INTO `seata`.`branch_table`(`branch_id`, `xid`, `transaction_id`, `resource_group_id`, `resource_id`, `lock_key`, `branch_type`, `status`, `client_id`, `application_data`, `gmt_create`, `gmt_modified`) VALUES (254739616784977921, '192.168.171.1:8091:254739616675926016', 254739616675926016, NULL, 'jdbc:mysql://localhost:3306/seata', NULL, 'AT', 0, 'springboot-bussiness:127.0.0.1:54144', NULL, '2022-04-05 22:44:17', '2022-04-05 22:44:17');
 * INSERT INTO `seata`.`global_table`(`xid`, `transaction_id`, `status`, `application_id`, `transaction_service_group`, `transaction_name`, `timeout`, `begin_time`, `application_data`, `gmt_create`, `gmt_modified`) VALUES ('192.168.171.1:8091:254739616675926016', 254739616675926016, 6, 'springboot-bussiness', 'my_test_tx_group', 'seata(java.lang.String)', 60000, 1649169857448, NULL, '2022-04-05 22:44:17', '2022-04-05 22:45:17');
 * INSERT INTO `seata`.`lock_table`(`row_key`, `xid`, `transaction_id`, `branch_id`, `resource_id`, `table_name`, `pk`, `gmt_create`, `gmt_modified`) VALUES ('jdbc:mysql://localhost:3306/seata^^^storage_tbl^^^1', '192.168.171.1:8091:254739616675926016', '254739616675926016', '254739616784977921', 'jdbc:mysql://localhost:3306/seata', 'storage_tbl', '1', '2022-04-05 22:44:17', '2022-04-05 22:44:17');
 * INSERT INTO `seata`.`undo_log`(`id`, `branch_id`, `xid`, `context`, `rollback_info`, `log_status`, `log_created`, `log_modified`, `ext`) VALUES (23, 254739616784977921, '192.168.171.1:8091:254739616675926016', 'serializer=jackson', 0x7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E756E646F2E4272616E6368556E646F4C6F67222C22786964223A223139322E3136382E3137312E313A383039313A323534373339363136363735393236303136222C226272616E63684964223A3235343733393631363738343937373932312C2273716C556E646F4C6F6773223A5B226A6176612E7574696C2E41727261794C697374222C5B7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E756E646F2E53514C556E646F4C6F67222C2273716C54797065223A22555044415445222C227461626C654E616D65223A2273746F726167655F74626C222C226265666F7265496D616765223A7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E5461626C655265636F726473222C227461626C654E616D65223A2273746F726167655F74626C222C22726F7773223A5B226A6176612E7574696C2E41727261794C697374222C5B7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E526F77222C226669656C6473223A5B226A6176612E7574696C2E41727261794C697374222C5B7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E4669656C64222C226E616D65223A226964222C226B657954797065223A225052494D4152595F4B4559222C2274797065223A342C2276616C7565223A317D2C7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E4669656C64222C226E616D65223A22636F6D6D6F646974795F636F6465222C226B657954797065223A224E554C4C222C2274797065223A31322C2276616C7565223A226161227D2C7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E4669656C64222C226E616D65223A22636F756E74222C226B657954797065223A224E554C4C222C2274797065223A342C2276616C7565223A347D5D5D7D5D5D7D2C226166746572496D616765223A7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E5461626C655265636F726473222C227461626C654E616D65223A2273746F726167655F74626C222C22726F7773223A5B226A6176612E7574696C2E41727261794C697374222C5B7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E526F77222C226669656C6473223A5B226A6176612E7574696C2E41727261794C697374222C5B7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E4669656C64222C226E616D65223A226964222C226B657954797065223A225052494D4152595F4B4559222C2274797065223A342C2276616C7565223A317D2C7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E4669656C64222C226E616D65223A22636F6D6D6F646974795F636F6465222C226B657954797065223A224E554C4C222C2274797065223A31322C2276616C7565223A226161227D2C7B2240636C617373223A22696F2E73656174612E726D2E64617461736F757263652E73716C2E7374727563742E4669656C64222C226E616D65223A22636F756E74222C226B657954797065223A224E554C4C222C2274797065223A342C2276616C7565223A337D5D5D7D5D5D7D7D5D5D7D, 0, '2022-04-05 22:44:17', '2022-04-05 22:44:17', NULL);
 */
